name: Detect new Promtail releases

on:
  # Manual trigger
  workflow_dispatch:
  # Check regularly the upstream every four hours
  schedule:
    - cron:  '0 8,12,16,20 * * *'

jobs:
  release-check:
    name: Detect new releases
    runs-on: ubuntu-latest
    steps:
      # Find out what is the latest release of grafana/loki
      - id: loki-latest-release
        uses: pozetroninc/github-action-get-latest-release@v0.5.0
        with:
          repository: grafana/loki
          excludes: prerelease, draft
      # Check out the tags of our repo to compare
      - name: Checkout canonical/loki-k8s-operator
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - id: find-files
        name: List files
        run: |
          find / -name *.yaml
      - id: check-new-release
        name: Check for new releases
        run: |
          git show-ref --tags promtail-${{steps.loki-latest-release.outputs.release}} --quiet
      - name: Trigger release build
        # If we do not have the tag we expect, trigger the new build
        if: ${{ failure() }}
        uses: ./.github/workflows/build-promtail-static-release.yaml@main
        with:
          upstream_promtail_release: ${{steps.loki-latest-release.outputs.release}}
